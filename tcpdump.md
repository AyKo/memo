# TCPDUMP: コンソールからパケットキャプチャをしたい

## 動機
パケットキャプチャをしたいが、コンソールしか環境がない。
（GUIのWiresharkはある程度わかるが、TeratermなどによるSSH接続しかない。
あるいはネットワークの帯域幅が狭くてGUIの起動は難しい、など）。

## 回答
tcpdumpコマンドもしくはtsharkコマンドを使う。

### 基本的な起動
``` tcpdump -n -i <NIC名> <キャプチャフィルタ>``` で起動する。

特にSSHでつないでいる場合はキャプチャフィルタの記述は必要である。
SSHでつないでいる際に、キャプチャフィルタを指定しない場合でSSHのパケットまでキャプチャしてしまうため非常に混乱した内容になる。
例）``` tcpdump -n -i eth0 host 192.168.10.1 ```

フィルタルールの詳細は『man pcap-filter』で読める。
なお、キャプチャフィルタはWiresharkのメイン画面のフィルタとは別であり書き方も異なるので注意する。
こちらはディスプレイフィルタという。Wiresharkのインタフェース選択画面で設定できるキャプチャフィルタとは同一である。

フィルタールールのよくあるパターン：
- 指定のIPアドレスとの通信…[host]（例：192.168.10.1との通信）  
  host 192.168.10.1 
- 指定のネットワークとの通信…[net]（例：192.168.10.0/24との通信）  
  net 192.168.10.0/24
- 指定のTCPポート番号の通信…[tcp port]（例：TCP ポート8000の通信）  
  tcp port 8000
- 指定のUDPポート番号の通信…[udp port]（例：SNMP=UDPポート161の通信）
  udp port 161
- 組み合わせ…[and/or]（例：192.168.10.1とのSNMPの通信）  
  host 192.168.10.1 and udp port 161
	
### ファイルに保存したい
オプション「-s 0 -w <ファイル名>」を使う。

保存したファイルはオプション「-r <ファイル名>」で開くことができる。また、Wireshark で開くこともできる。
オプション「-s 0」は、キャプチャーするサイズを最大サイズとすることを示す。
古いバージョンのtcpdumpの場合、指定しない場合のキャプチャーサイズが96バイトで、
オプション指定しないとすべてのデータが保存されない
（96バイトはソースファイルによると「ether + IPv6 + TCP + 22」とある。
またその後のバージョンでディフォルトのサイズは最大サイズに変更されている）。

### 実際に入出力したパケットと異なる場合がある
ある状況においては、キャプチャしたパケットと実際に入出力したパケットが異なる場合がある。
特に送信するパケットのチェックサムエラーは気にしないでよい。

tcpdumpおよびtshark、wiresharkは、pcapライブラリによってカーネルがドライバから受けたフレームのコピーを受けとることで実現している。
よって、ドライバによってフレームの改変が行われている場合はそれが分からないので注意が必要なことがある。
この改変はオフロード機能といって負荷軽減を目的とする。

大抵の場合は問題にならないが、
- チェックサムに注意が必要な場合
- ジャンボフレームであるかを気にしなければならない場合

などでは、注意を払う必要がある。

このオフロード機能による影響について、おそらく最初に気が付くのは、
パケットキャプチャした際に見られる送信するパケットのチェックサムエラーだと思う。
チェックサムのオフロード機能が有効である場合、チェックサムの計算をNICでおこなうため、カーネル上でおこなわれない。
パケットキャプチャでのフレームのコピーは、ドライバに受け渡す前におこなわれるから、一見チェックサムが常にエラーになる。
この問題に対する簡単な対処は、単に気にしないことである。

また、オフロード機能によって複数のパケットを１つのパケットにまとめることがある。
そうするとジャンボフレームにしたり、ジャンボフレームに見せかけたりするが、パケットキャプチャ上ではそれを判別できない。
