# ファイルサイズ０に気を付ける

## 動機
情報をファイルに保存して読み書きしている。内容が読めないバグがたまに発生する。

## 回答
ファイル移動を用いたテクニックを用いる。

情報をファイルに保存してに書き込んで、さらにファイルの読み込みが非同期に発生する場合は、ファイルサイズが０であったり、中途半端に書き込んだ状態が存在することを考慮する。
考慮がされていない場合、まれに内容が読めないような再現率の低いバグが発生するかもしれない。

### どういう場合にファイルサイズ０になったり中途半端になるか
ファイルの作成をするにあたり、fopen()で"w"を付与したり、cpコマンド、ftpやscp等の転送を使っている場合、
たとえファイル先がすでに存在していたとしても一瞬、ファイルサイズが０になりそこから書き込みがはじまるため、中途半端な状態がある。

### ファイル移動を用いたテクニック
これを避けるためには、rename()を用いたファイル移動を用いたテクニックが有効である。
テンポラリファイルにデータを書き込み完了したのちに、ファイル移動でファイルを更新する。
rename()は不可分操作であるため、いかなるタイミングで読み込みが発生しても中途半端な状態はしない。

もちろん、セマフォなどを用いて排他処理をおこなえば、中途半端な状態を作り出さないことはできる。
しかし、その場合はそのファイルを用いるすべてのプログラムでセマフォを意識する必要がある。
そのため、排他制御を必要としないファイル移動の方法のほうが有利なこともある。

### シェル上やリモートファイル転送で同様のことをおこないたい
もし、シェルの上で同様のことをおこないたい場合、renameコマンドまたはmvコマンドを用いればよい
（mvコマンドの方が一般的だが、送り元とあて先が異なるファイルシステムである場合は不可分操作でないcpコマンド相当に置き換わるので注意する）
リモート転送によるファイルで同様のことをおこないたい場合、ftpであればrenameコマンドを用いる。
scpコマンドは私が知っている限りでは不可分操作のための手段が存在しないが、代わりにrsyncコマンドを[--delay-updates]オプション付きでおこなえば実現できる。

### ディレクトリに対して同様のことをおこないたい
空でないディレクトリに対するrename()による置き換えはできない。
（※3.15以上のカーネルなら、renameat2()を使いinodeを交換するというやり方で目的を達成できる）

代替えとして、以下の方法が使える：
- ディレクトリに対してのシンボリックリンクを作る。シンボリックリンクに対してrename()を実行することで疑似的に不可分操作でディレクトリを置き換える。
    - 読み手側は常にシンボリック経由で読み取りをするようにする
    - ディレクトリを置き換える側は、置き換え対象のディレクトリを準備し、そのシンボリックリンクを作成する。作ったシンボリックリンクで、読み手のシンボリックリンクを置き換える

## 参考文書
rename()の詳細（特にどういうケースで失敗するか）
- [man 2 rename](https://linuxjm.osdn.jp/html/LDP_man-pages/man2/rename.2.html)

rename()やmvコマンドでの実例など
- [そのファイル、安全に更新できていますか？](https://heartbeats.jp/hbblog/2013/10/atomic01.html)  
追加情報に、mvコマンドが昔は不可分操作でなかったこと（を指摘されている）が書いてあることも興味深い。
	