# ログがリアルタイムで表示されない

## 動機
プログラムがログをファイルに保存している。
そのファイルを tail -F でリアルタイムに表示しているが、ログ出力のタイミングとそれが表示されるタイミングが違う。
遅れて表示されたり、ログが感覚的にカクカクと表示する。

## 回答
標準入出力ライブラリによってバッファリング制御されている。

ログの出力側で対処する場合は、ログを出力するたびに fflush() を呼ぶか、事前に setbuf()/setlinebuf() でバッファリング制御を変更する。
もし、ログの出力が標準出力である場合は、stdbuf コマンドで、外部からバッファリング制御を変更することもできる。

printf()、fwrite() をはじめとした標準入出力ライブラリ(stdio.h)を用いた出力はバッファリング制御される。
ただし、バッファリング制御は条件によって挙動がかわる。
例えば、単体試験時にログをコンソールに出力していて、その場合は特に何もしなくともリアルタイムで表示されていたとする。が、それをファイルに出力するようにした途端に（例えば「コマンド > ログ出力先ファイル」で実行するようにした）、リアルタイムでなくなってしまう。

また、grep コマンドなども標準入出力ライブラリによってバッファリング制御されることに注意すること。
こちらもコンソールに出力する場合と、ファイルなどに出力した場合で挙動が変わる。

### バッファリング制御の条件
以下の場合は特に制御をしなくともバッファリング制御されない：
- 出力先がコンソール
- 標準エラー出力
- 標準入出力ライブラリを使わずに直接出力している(writeなど)

それ以外、例えばprintf()を用いていて、出力先がファイルであったりパイプであったりする場合はバッファリング制御されてしまう。

バッファリング制御されてしまう例：
- ``` ./program > log.txt ```
- ``` ./program | grep "important" ```

### grepなどのコマンドもバッファリング制御される
なお、一般的に用いる grep コマンド等も標準入出力ライブラリによってバッファリング制御されることが多い。

例えば、ログファイルを grep 等でパイプにて２重以上にフィルタをする場合はバッファリング制御される。
以下、コンソールからコマンドを入力したとして：
- バッファリングされない   
``` tail -f logfile.txt | grep "important" ```

- バッファリングされる  
``` tail -F logfile.txt | grep "important" | grep "error" ```  
 (grep "important" でバッファリングされる。grep "error" はコンソールが出力先なのでバッファリングされない。なお tail はプログラムの作りでバッファ制御されないようになっている)

grep などには、バッファリング制御を変更するオプション「--line-buffered」があり、これをしていると期待通りになる。

- バッファリングされない  
``` tail -F logfile.txt | grep --line-buffered "important" | grep "error" ```

また、上記で述べた stdbuf コマンドを用いても期待通りになる。stdbuf コマンドはいかなるコマンドを対象にできるため、汎用的に使えて便利である。

- バッファリングされない  
``` tail -F logfile.txt | stdbuf -oL grep "important" | grep "error" ```

### 他のバッファリング制御をとめるやり方
特にテキストストリームに対してのフィルタをおこなうコマンドでは、バッファリング制御を変更する方法を知っておくと便利である。

- grep： ```--line-buffered```
- sed: ```-u```
- awk: 出力するたびに ``` fflush() ``` を呼ぶ
- python: ```-u```


## 参考文書
標準入出力ライブラリのバッファリング制御の条件が記載されている。
- W.Richard Stevens（2000）『詳解UNIXプログラミング 新装版』ピアソンエデュケーション
（※第3版が出版されている）
