# 受信ポートをエフェメラルポートの範囲内にしない

## 動機
TCPまたはUDPの受信ポートの番号にエフェメラルポートの範囲内を指定すると、bind()に失敗することがある。

## 回答
bind()するポート番号は、エフェメラルポート番号の範囲を避ける。RHEL6の場合のエフェメラルポート番号の範囲のディフォルト値は32768～60999である。

TCPかUDPでクライアント通信をすると、送信元（つまり自分自身側）のポート番号は一般にOSが自動で付与する。このポートを、一時ポートまたはエフェメラルポートという。プログラムで使おうとしたポート番号が、偶然一時ポートとして使われてしまっていた場合、bind()は失敗する。

なお、これはSO_REUSEADDRオプションを使ったとしても上手くいかない。少なくともLinuxにおいて、SO_REUSEADDRオプションで期待通りに動作するのは、これからbindするソケットだけでなく、すでにそのポートを使っている側の両方でオプションを設定が必要だからである（この動作は独自調査による）。

OS既設のプログラムも含め、すべての動作するプログラムにSO_REUSEADDRオプションの付与をさせることはできない。よって、我々のプログラム側で一時ポートを用いないようにするか、OSの設定を修正して一時ポートの範囲を変えるしか方法がない。

なお、``` sysctl net.ipv4.ip_local_port_range``` で現在の一時ポートの範囲を確認できる。また、例えば ```sysctl -w net.ipv4.ip_local_port_range="32768 60000"``` コマンドで現在の一時ポートの設定32768～60000に変更できる。
