# 複雑な設計・コード

## 動機
複雑な設計・コードとは何か。複雑さを避けるためにはどうしたらよいか。

## 回答
複雑な設計・コードとは、機能・オブジェクト・プロセス・関数・変数・行などの要素の間の関係の数が多いものを指す。
複雑さを避けるためには：
- 要素の数そのものを減らす（規模を減らす）
- 要素の数が多い場合は、複数の要素を意味のあるかたまりとして取り扱う（分割統治）
- 各要素の間の関係をできるだけ少なくする（関係を見直す）

のようにすればよい。

### 本質的な複雑さ・作られた複雑さ

複雑さは大きく２つに分けられる。
１つは本質的な複雑さ、もう１つは作られた複雑さである。
ここで述べるのは作られた複雑さである。
作られた複雑さに対してしか対処ができないからである。

本質的な複雑さとは、設計・コードにする対象そのものが複雑であることを指す。
例えば、ＯＳのメモリ管理の設計をしなければならない場合、そのものが難しいためある程度以上の複雑さは免れない。
作られた複雑さとは、本質的なもの以外の複雑さを指す。
例えばいわゆるスパゲッティコードのように、やりたいことに対して不必要に複雑なものをいう。

### 複雑であるとどんな弊害があるか
作られた複雑さへの対処の考えを述べる前に、なぜ複雑さに対して敏感になる必要があるかを認識しておく必要がある。
複雑さというのはソフトウェアの開発に悪影響を及ぼす。
しかし、複雑さに対しての悪影響は単純な増加でなく、例えば指数関数的であるような非線形の関係がある。
それゆえに、特に大きい規模なものが対象の場合は、敏感に取り扱う必要がある。

複雑な設計・コードでプログラムを作ったとする。プログラムは：
- 複雑であるほど、バグが入り込みやすい
- 複雑であるほど、バグの原因箇所の特定が難しい
- 複雑であるほど、バグの修正が難しい

ことは明らかである。よって、少なくともバグに関することを考えても、複雑さは少なくとも３乗に比例して悪影響があるといえる。

さらに悪いことに：
- 複雑であるほど、バグ修正後にさらに複雑になりやすい
- 複雑であるほど、バグ修正後にさらにバグを入れ込みやすい

といったようにフィードバック的な性質を持つため、指数関数で表せないほど急激な悪影響を及ぼす場合がある。
ある閾値を超えるような最悪のケースでは、バグを修正すればするほどバグが増える。
バグ修正でバグ増やしながらさらに複雑さが増し、複雑さの上昇に伴って修正に対するバグ増加量がさらに増える。

### 対処１：規模を減らす
規模を減らすというのは単純に全体量を減ずることである。
要素の数と複雑さとの関係もまた非線形の関係を持つ。要素間の関係の数を複雑さとするのならば、要素が増えれば要素間の増えうる関係の数は２乗に比例するからである。
よって、要素の数を減らすように努力することは複雑さへの効果として最も大きい。

例）
- 顧客と調整しｘｘ機能を無くす
- 不必要な処理を抹消する
- リファクタリングして行数を減らす

### 対処２：分割統治
分割統治とは「そのままでは解決できない大きな問題を小さな問題に分割し、その全てを解決することで、最終的に最初の問題全体を解決する、という問題解決の手法」である（Wikipediaより）。
複数の要素で関係性が強いものを１つの意味あるかたまりに捉えなおすことで、実質上の要素数を減らすことができる。
ソフトウェアエンジニアリングにおける複雑さへの対処、例えば構造化、オブジェクト指向などはすべて、ここで意味する分割統治の手法である。

なお、この手法は適切な分量であることが重要である。
複数の要素をあるかたまりとして分割したとしても、かたまり同士の関係が増える。
完全に分割したものと、まったく分割しないものでは関係性の数は等しい。
適切な状態は、高凝縮度・低結合度な状態である。
高凝縮度はかたまりにした要素群の関連が強いこと、低結合度とはかたまり同士の関連が弱いことである。

例）
- 大きなドメインを、サブドメインに分割する
- 多くの機能を持つプログラムから、１つのことをするプログラムとして複数に分離し、それらをつなぎ合わせるようにした（UNIX哲学）
- 似たパターンの概念・機能・処理を切り出して抽象化する（パターン抽出・クラス化・関数化）
- データ構造と振る舞いの分離（template化・define化）
- 長すぎる関数の処理を複数の関数に分割する（関数抽出リファクタリング）
　
### 対処３：関係を見直す
要素同士の関係は、必ずしも双方向でなく単方向である場合がよくある。
例えばある変数が読み書き両方であり、それを読み出し専用にできた場合、
その変数に関係する関係性は半分になる（その変数に対する「書く」という関係性がなくなる）。

例）
- constを使い、読み込み専用であることを示す。
- データの流れを一方向に限定する。例えばパイプ＆フィルタパターンを適用する。（シェルスクリプトで「処理・変数代入・処理…」を「処理｜処理｜…」のようにする。JavaScript等のメソッドチェーンの様に実装するなど）

## 参考文書
複雑さに関する考え方
- G・M・ワインバーグ（1994）『ワインバーグのシステム思考法 ソフトウェア文化を創る〈1〉』共立出版

シンプルさを是とするUNIX哲学
- Mike Gancarz（2001）『UNIXという考え方―その設計思想と哲学』オーム社

リファクタリング
- マーチン・ファウラー（2000）『リファクタリング―プログラムの体質改善テクニック 』ピアソンエデュケーション （※オーム社から新装版が出版されている）

ドメイン分析
- ジェームズ・O・コプリン（2009）『マルチパラダイムデザイン』ピアソンエデュケーション
