# 大量の仮想メモリを使っているが大丈夫か

## 動機
作成した常駐するプログラムについて、topやpsコマンドでみたら仮想メモリ(VSZ、VIRT)で大量のメモリを使っているように見える。
ターゲットマシンには、それほどメモリを搭載していないが大丈夫なのか？

## 回答
それまでの最大スレッド数×74Mバイトから大きく逸脱してない場合はおそらく大丈夫。
ただし、どちらにしてもRSS(常駐セット)の量が多い場合は注意する。

大きく逸脱している場合はメモリリークを疑うべきかもしれない。
詳しくは、pmapコマンドでメモリマップをみて確認する。
		
### スレッド数の確認のしかた
現在のスレッド数は、psコマンドに[ -L ]オプションをつける。NLWPの列が現在のスレッド数。
私が知っている限り、それまでの最大スレッド数を公の方法で知る方法はない。
代案として私はpmap コマンドでメモリマップを見て推測することがある（後述）

### なぜ大丈夫と言えるか
スレッドを作成した際に、標準ライブラリがあらかじめ仮想メモリ上で領域を確保しただけで、実際に用いられるまでは何の影響もないため。
（「おそらく」というのは、十分に余裕をもって確保されたであろうこれらの領域を使い切るような動作をするプログラムに対しては、この限りではないため）
		
### 74Mバイト？
環境によって変わるが我々の環境(RHEL6相当64bit)の場合、スレッドを作成するとスレッド毎のスタック領域として10Mバイト、そのスレッドで一度でもmalloc相当を呼び出すと小さなメモリ用の領域として64Ｍバイトの仮想メモリが暗黙的に確保される。2つを合計して74M。

スレッドを作成した際の10Mバイトは、スレッドごとに確保されるスタック領域で ```ulimit``` コマンドで確認・変更できる。malloc相当を呼び出した際の64Mバイトは、小さなメモリ確保用にあらかじめ確保される領域で、知っている限り確認も変更もできない(glibcライブラリの中でdefine定義されていた。なお32bitの場合は11Mバイトだった)。

### なぜスレッド数で判断するのか
我々が対象とするプログラムはおおむね、マルチスレッドでかつスレッドの数は割と多めであり(対象によっては100を超える)、かつ上記に述べたようにスレッドあたりに仮想メモリサイズが比較的大きい(74Mバイト)からである。例えば、スレッド数が100個で固定的に動作しているプログラムであれば、100×74Ｍバイト=7.4Ｇバイトの仮想メモリをほとんど何も動作しなくても確保する。

「最大」スレッド数とするのは、スタック領域の10Mバイトもmallocの64Mバイト領域もすでに終了したスレッドのものは捨てられず、後で再利用されるからである（注意：厳密に調べていない。経験に基づく）。

### もっと細かく確認したい
pmap コマンドを用いると、指定したプロセスのメモリマップが見える。
malloc相当で確保されたエリアは[anon](Anonymous)なので基本的にこれだけを見ればよい。それ以外としては、プログラム・共有ライブラリ・共有メモリ等となる。

## 参考情報
	• 各manページ
	• [malloc(3)のメモリ管理構造](https://www.valinux.co.jp/technologylibrary/document/linux/malloc0001/)
